<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Listing</title>
  <link rel="stylesheet" href="clist.css" />
</head>
<body>
  <header>
    <h1>RealEstate Pro</h1>
    <nav>
      <a href="#">Contact</a>
      <a href="#" id="logoutBtn">Log Out</a>
    </nav>
  </header>

  <section class="form-container">
    <form id="listingForm" action="submit-listing.php" method="POST" enctype="multipart/form-data">
      <h3>Create Property Listing</h3>

      <input type="text" name="title" class="box" required placeholder="Property Title" />
      <input type="number" name="price" class="box" required placeholder="Price (USD)" />
      <input type="text" name="location" class="box" required placeholder="Location: Country/State/LGA/Street" />

      <select name="property_type" required>
        <option value="" disabled selected>Select Property Type</option>
        <option value="house">House</option>
        <option value="apartment">Apartment</option>
        <option value="land">Land</option>
        <option value="commercial">Commercial</option>
      </select>

      <textarea name="description" class="box" required placeholder="Description of the property"></textarea>

      <label for="imageInput" class="upload-label">Upload Images</label>
     <br>
     <br>
      <input type="file" name="images[]" id="imageInput" accept="image/*" multiple required />
      <br>
      <br>
      <small class="note">Max 6 images, each under 2MB</small>

      <div id="imagePreviewContainer" class="image-preview-container"></div>

      <div class="form-group">
        <label for="video" class="vid">Upload Video</label>
        <br>
        <br>
        <input type="file" name="video" id="video" accept="video/*" />
      </div>

      <div class="video-preview" id="video-preview"></div>

      <input type="text" name="contact" class="box" placeholder="Contact Number" required />
      <input type="submit" value="Post Ads" name="submit" class="btn" />
      <div id="statusText" style="margin-top: 10px; font-weight: bold; color: #333;"></div>
    </form>
  </section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDI3NCZ-bF_9hEbXAjkIX_1tuIYyfM4QNg",
    authDomain: "real-estate-b0c92.firebaseapp.com",
    projectId: "real-estate-b0c92",
    storageBucket: "real-estate-b0c92.appspot.com",
    messagingSenderId: "708869112975",
    appId: "1:708869112975:web:f5ccfce02b74a23553dcfa"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dpl0ivvfv/upload";
  const UPLOAD_PRESET = "realestate_pics";
  
  const form = document.getElementById("listingForm");
  const statusText = document.getElementById("statusText");
  
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Please log in first.");
      window.location.href = "login.html";
    }
  });
  
  function uploadToCloudinary(file) {
    return new Promise((resolve, reject) => {
      const fd = new FormData();
      fd.append("upload_preset", UPLOAD_PRESET);
      fd.append("file", file);
      
      const xhr = new XMLHttpRequest();
      xhr.open("POST", CLOUDINARY_URL);
      
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          const res = JSON.parse(xhr.responseText);
          resolve(res.secure_url);
        } else {
          reject(new Error("Image upload failed"));
        }
      };
      
      xhr.onerror = () => reject(new Error("Network error"));
      xhr.send(fd);
    });
  }
  
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusText.textContent = "⏳ Starting upload...";
    const submitBtn = form.querySelector('input[type="submit"]');
    submitBtn.disabled = true;
    
    try {
      const user = auth.currentUser;
      if (!user) throw new Error("User not authenticated.");
      
      const images = document.getElementById("imageInput").files;
      if (images.length === 0) throw new Error("Please upload at least 1 image.");
      if (images.length > 6) throw new Error("Max 6 images allowed.");
      
      const imageUrls = [];
      for (let i = 0; i < images.length; i++) {
        if (images[i].size > 2 * 1024 * 1024) throw new Error("Each image must be < 2MB");
        statusText.textContent = `⏳ Uploading image ${i + 1} of ${images.length}...`;
        const url = await uploadToCloudinary(images[i]);
        imageUrls.push(url);
      }
      
      let videoUrl = "";
      const videoFile = document.getElementById("video").files[0];
      if (videoFile) {
        statusText.textContent = "⏳ Uploading video...";
        videoUrl = await uploadToCloudinary(videoFile);
      }
      
      const listing = {
        title: form.title.value,
        price: parseFloat(form.price.value),
        location: form.location.value,
        property_type: form.property_type.value,
        description: form.description.value,
        images: imageUrls,
        video: videoUrl,
        contact: form.contact.value,
        createdAt: serverTimestamp(),
        userId: user.uid,
        status: "active" // <-- Added field here
      };
      
      statusText.textContent = "⏳ Saving listing...";
      await addDoc(collection(db, "listings"), listing);
      
      statusText.textContent = "✅ Listing posted successfully!";
      setTimeout(() => {
        window.location.href = "my-listings.html";
      }, 1500);
      
    } catch (error) {
      statusText.textContent = "❌ " + error.message;
      submitBtn.disabled = false;
    }
  });
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDI3NCZ-bF_9hEbXAjkIX_1tuIYyfM4QNg",
    authDomain: "real-estate-b0c92.firebaseapp.com",
    projectId: "real-estate-b0c92",
    storageBucket: "real-estate-b0c92.firebasestorage.app",
    messagingSenderId: "708869112975",
    appId: "1:708869112975:web:f5ccfce02b74a23553dcfa",
    measurementId: "G-CGCBKW9K24"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  
  const logoutBtn = document.getElementById("logoutBtn");
  
  logoutBtn.addEventListener("click", async (e) => {
    e.preventDefault(); // prevent link navigation
    
    try {
      await signOut(auth);
      alert("Logged out!");
      window.location.href = "login.html"; // redirect after logout
    } catch (error) {
      alert("Logout failed: " + error.message);
    }
  });
</script>
<script>const imageInput = document.getElementById("imageInput");
const imagePreview = document.getElementById("imagePreviewContainer");

// Store selected files here (since FileList is read-only)
let selectedFiles = [];

imageInput.addEventListener("change", () => {
const files = Array.from(imageInput.files);

// Add new files, but limit total to 6
for (const file of files) {
if (selectedFiles.length >= 6) {
alert("Maximum 6 images allowed");
break;
}
// Check if already added (by name + size)
if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
selectedFiles.push(file);
}
}

updatePreview();
updateInputFiles();
});

function updatePreview() {
imagePreview.innerHTML = ""; // Clear current previews

selectedFiles.forEach((file, index) => {
const reader = new FileReader();

reader.onload = e => {
const div = document.createElement("div");
div.style.position = "relative";
div.style.width = "100px";
div.style.height = "100px";
div.style.border = "1px solid #ccc";
div.style.borderRadius = "8px";
div.style.overflow = "hidden";

const img = document.createElement("img");
img.src = e.target.result;
img.style.width = "100%";
img.style.height = "100%";
img.style.objectFit = "cover";

const btn = document.createElement("button");
btn.textContent = "×";
btn.style.position = "absolute";
btn.style.top = "2px";
btn.style.right = "2px";
btn.style.background = "rgba(0,0,0,0.5)";
btn.style.color = "#fff";
btn.style.border = "none";
btn.style.borderRadius = "50%";
btn.style.width = "20px";
btn.style.height = "20px";
btn.style.cursor = "pointer";
btn.title = "Remove image";

btn.addEventListener("click", () => {
selectedFiles.splice(index, 1);
updatePreview();
updateInputFiles();
});

div.appendChild(img);
div.appendChild(btn);
imagePreview.appendChild(div);
};

reader.readAsDataURL(file);
});
}

// Because input.files is read-only, we can't directly set it.
// But we can create a new DataTransfer and set files from selectedFiles.
function updateInputFiles() {
const dataTransfer = new DataTransfer();
selectedFiles.forEach(file => dataTransfer.items.add(file));
imageInput.files = dataTransfer.files;
}</script>
<script>const videoInput = document.getElementById("video");
const videoPreview = document.getElementById("video-preview");

videoInput.addEventListener("change", () => {
videoPreview.innerHTML = ""; // Clear existing preview

const file = videoInput.files[0];
if (!file) return;

// Check if file is video (optional)
if (!file.type.startsWith("video/")) {
alert("Please select a valid video file.");
videoInput.value = "";
return;
}

// Create video element with controls
const video = document.createElement("video");
video.src = URL.createObjectURL(file);
video.controls = true;
video.width = 320; // or your preferred size
video.style.borderRadius = "8px";
video.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";

videoPreview.appendChild(video);
});</script>
</body>
</html>